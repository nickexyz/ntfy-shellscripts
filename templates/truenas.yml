# Use the Slack type in TrueNAS
# URL: https://example.com/my_topic?template=truenas
#
# Created with Claude and pretty untested.
# Seems to work fine so far, but bugs may exist.
# Use at your own risk. :)
#

topic: "{{ .username | default \"truenas\" | lower | replace \" \" \"-\" }}"

title: >-
  {{- if .username -}}
    ðŸ—„ï¸ {{ .username }}
  {{- else -}}
    ðŸ—„ï¸ TrueNAS Alert
  {{- end -}}

message: >-
  {{- .text -}}
  {{- if .attachments -}}
    {{- range .attachments -}}
      {{- if .pretext }}

  {{ .pretext }}{{ end -}}
      {{- if .title }}

  {{ .title }}{{ end -}}
      {{- if .text }}

  {{ .text }}{{ end -}}
      {{- if .fields }}
        {{- range .fields }}

  â€¢ {{ .title }}: {{ .value }}
        {{- end -}}
      {{- end -}}
      {{- if .footer }}

  _{{ .footer }}_{{ if .ts }} â€¢ <t:{{ .ts }}:R>{{ end }}
      {{- end -}}
    {{- end -}}
  {{- end -}}

tags:
  - "truenas"
  - "{{ .username | default \"system\" | lower | replace \" \" \"-\" }}"
  - >-
    {{- if .attachments -}}
      {{- range .attachments -}}
        {{- if eq .color "danger" -}}
          critical
        {{- else if eq .color "warning" -}}
          warning
        {{- else if eq .color "good" -}}
          success
        {{- else if or (contains (.text | lower) "critical") (contains (.text | lower) "failed") (contains (.text | lower) "error") (contains (.text | lower) "degraded") -}}
          critical
        {{- else if or (contains (.text | lower) "warning") (contains (.text | lower) "alert") (contains (.text | lower) "slow") -}}
          warning
        {{- else if or (contains (.text | lower) "success") (contains (.text | lower) "completed") (contains (.text | lower) "healthy") (contains (.text | lower) "online") -}}
          success
        {{- else -}}
          info
        {{- end -}}
      {{- end -}}
    {{- else if or (contains (.text | lower) "critical") (contains (.text | lower) "failed") (contains (.text | lower) "error") (contains (.text | lower) "degraded") (contains (.text | lower) "offline") -}}
      critical
    {{- else if or (contains (.text | lower) "warning") (contains (.text | lower) "alert") (contains (.text | lower) "slow") -}}
      warning
    {{- else if or (contains (.text | lower) "success") (contains (.text | lower) "completed") (contains (.text | lower) "healthy") (contains (.text | lower) "online") -}}
      success
    {{- else -}}
      info
    {{- end -}}

priority: >-
  {{- if .attachments -}}
    {{- range .attachments -}}
      {{- if or (eq .color "danger") (contains (.text | lower) "critical") (contains (.text | lower) "failed") (contains (.text | lower) "offline") (contains (.text | lower) "degraded") -}}
        5
      {{- else if or (eq .color "warning") (contains (.text | lower) "warning") (contains (.text | lower) "alert") (contains (.text | lower) "slow") -}}
        4
      {{- else if or (eq .color "good") (contains (.text | lower) "success") (contains (.text | lower) "completed") (contains (.text | lower) "healthy") (contains (.text | lower) "online") -}}
        2
      {{- else -}}
        3
      {{- end -}}
    {{- end -}}
  {{- else if or (contains (.text | lower) "critical") (contains (.text | lower) "failed") (contains (.text | lower) "offline") (contains (.text | lower) "degraded") -}}
    5
  {{- else if or (contains (.text | lower) "warning") (contains (.text | lower) "alert") (contains (.text | lower) "slow") -}}
    4
  {{- else if or (contains (.text | lower) "success") (contains (.text | lower) "completed") (contains (.text | lower) "healthy") (contains (.text | lower) "online") -}}
    2
  {{- else -}}
    3
  {{- end -}}

icon: >-
  {{- if .attachments -}}
    {{- range .attachments -}}
      {{- if or (eq .color "danger") (contains (.text | lower) "critical") (contains (.text | lower) "failed") (contains (.text | lower) "offline") -}}
        ðŸš¨
      {{- else if or (eq .color "warning") (contains (.text | lower) "warning") (contains (.text | lower) "alert") (contains (.text | lower) "slow") -}}
        âš ï¸
      {{- else if or (eq .color "good") (contains (.text | lower) "success") (contains (.text | lower) "completed") (contains (.text | lower) "healthy") (contains (.text | lower) "online") -}}
        âœ…
      {{- else if contains (.text | lower) "pool" -}}
        ðŸ’¾
      {{- else if contains (.text | lower) "disk" -}}
        ðŸ’¿
      {{- else if contains (.text | lower) "scrub" -}}
        ðŸ§¹
      {{- else if contains (.text | lower) "backup" -}}
        ðŸ“¦
      {{- else if contains (.text | lower) "snapshot" -}}
        ðŸ“¸
      {{- else if contains (.text | lower) "ups" -}}
        ðŸ”‹
      {{- else if contains (.text | lower) "temperature" -}}
        ðŸŒ¡ï¸
      {{- else if contains (.text | lower) "network" -}}
        ðŸŒ
      {{- else if contains (.text | lower) "jail" -}}
        ðŸ¢
      {{- else if contains (.text | lower) "plugin" -}}
        ðŸ”Œ
      {{- else -}}
        ðŸ—„ï¸
      {{- end -}}
    {{- end -}}
  {{- else if or (contains (.text | lower) "critical") (contains (.text | lower) "failed") (contains (.text | lower) "offline") -}}
    ðŸš¨
  {{- else if or (contains (.text | lower) "warning") (contains (.text | lower) "alert") (contains (.text | lower) "slow") -}}
    âš ï¸
  {{- else if or (contains (.text | lower) "success") (contains (.text | lower) "completed") (contains (.text | lower) "healthy") (contains (.text | lower) "online") -}}
    âœ…
  {{- else if contains (.text | lower) "pool" -}}
    ðŸ’¾
  {{- else if contains (.text | lower) "disk" -}}
    ðŸ’¿
  {{- else if contains (.text | lower) "scrub" -}}
    ðŸ§¹
  {{- else if contains (.text | lower) "backup" -}}
    ðŸ“¦
  {{- else if contains (.text | lower) "snapshot" -}}
    ðŸ“¸
  {{- else if contains (.text | lower) "ups" -}}
    ðŸ”‹
  {{- else if contains (.text | lower) "temperature" -}}
    ðŸŒ¡ï¸
  {{- else if contains (.text | lower) "network" -}}
    ðŸŒ
  {{- else if contains (.text | lower) "jail" -}}
    ðŸ¢
  {{- else if contains (.text | lower) "plugin" -}}
    ðŸ”Œ
  {{- else -}}
    ðŸ—„ï¸
  {{- end -}}

# Set click URL from attachments if available
click: >-
  {{- if .attachments -}}
    {{- range .attachments -}}
      {{- if .title_link }}{{ .title_link }}{{ end -}}
    {{- end -}}
  {{- end -}}

# Add email notifications for critical TrueNAS issues
email: >-
  {{- if or (contains (.text | lower) "critical") (contains (.text | lower) "failed") (contains (.text | lower) "offline") (contains (.text | lower) "degraded") -}}
    your-email@example.com
  {{- end -}}

# Smart delays to reduce notification spam
delay: >-
  {{- if contains (.text | lower) "scrub" -}}
    2m
  {{- else if contains (.text | lower) "backup" -}}
    1m
  {{- else if or (contains (.text | lower) "info") (contains (.text | lower) "completed") -}}
    30s
  {{- end -}}
